<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN"
        "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
 <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
 <title>Example Documentation</title>
 <link rel="stylesheet" href="doxygen.css" type="text/css">
</head>
<body>

<div class="main">

<!-- doxygen-header.html ends here -->
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="annotated.html">Data&nbsp;Structures</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Data&nbsp;Fields</a> | <a class="qindex" href="globals.html">Globals</a> | <a class="qindex" href="examples.html">Examples</a></div>
<h1>cfgtest.c</h1><pre><div class="fragment"><span class="preprocessor">#include "<a class="code" href="confuse_8h.html">confuse.h</a>"</span>
<span class="preprocessor">#include &lt;string.h&gt;</span>

<span class="keywordtype">void</span> print_func(<a name="_a0"></a><a class="code" href="structcfg__opt__t.html">cfg_opt_t</a> *opt, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> index, FILE *fp)
{
    fprintf(fp, <span class="stringliteral">"%s(foo)"</span>, opt-&gt;<a name="a1"></a><a class="code" href="structcfg__opt__t.html#cfg__opt__to0">name</a>);
}

<span class="keywordtype">void</span> print_ask(<a class="code" href="structcfg__opt__t.html">cfg_opt_t</a> *opt, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> index, FILE *fp)
{
    <span class="keywordtype">int</span> value = <a name="a2"></a>cfg_opt_getnint(opt, index);
    <span class="keywordflow">switch</span>(value) {
        <span class="keywordflow">case</span> 1:
            fprintf(fp, <span class="stringliteral">"yes"</span>);
            <span class="keywordflow">break</span>;
        <span class="keywordflow">case</span> 2:
            fprintf(fp, <span class="stringliteral">"no"</span>);
            <span class="keywordflow">break</span>;
        <span class="keywordflow">case</span> 3:
        <span class="keywordflow">default</span>:
            fprintf(fp, <span class="stringliteral">"maybe"</span>);
            <span class="keywordflow">break</span>;
    }
}

<span class="comment">/* function callback</span>
<span class="comment"> */</span>
<span class="keywordtype">int</span> cb_func(<a name="_a3"></a><a class="code" href="structcfg__t.html">cfg_t</a> *cfg, <a class="code" href="structcfg__opt__t.html">cfg_opt_t</a> *opt, <span class="keywordtype">int</span> argc, <span class="keyword">const</span> <span class="keywordtype">char</span> **argv)
{
    <span class="keywordtype">int</span> i;

    <span class="comment">/* at least one parameter is required */</span>
    <span class="keywordflow">if</span>(argc == 0) {
        <a name="a4"></a>cfg_error(cfg, <span class="stringliteral">"Too few parameters for the '%s' function"</span>,
                  opt-&gt;<a class="code" href="structcfg__opt__t.html#cfg__opt__to0">name</a>);
        <span class="keywordflow">return</span> -1;
    }

    printf(<span class="stringliteral">"cb_func() called with %d parameters:\n"</span>, argc);
    <span class="keywordflow">for</span>(i = 0; i &lt; argc; i++)
        printf(<span class="stringliteral">"parameter %d: '%s'\n"</span>, i, argv[i]);
    <span class="keywordflow">return</span> 0;
}

<span class="comment">/* value parsing callback</span>
<span class="comment"> *</span>
<span class="comment"> * VALUE must be "yes", "no" or "maybe", and the corresponding results</span>
<span class="comment"> * are the integers 1, 2 and 3.</span>
<span class="comment"> */</span>
<span class="keywordtype">int</span> cb_verify_ask(<a class="code" href="structcfg__t.html">cfg_t</a> *cfg, <a class="code" href="structcfg__opt__t.html">cfg_opt_t</a> *opt, <span class="keyword">const</span> <span class="keywordtype">char</span> *value, <span class="keywordtype">void</span> *result)
{
    <span class="keywordflow">if</span>(strcmp(value, <span class="stringliteral">"yes"</span>) == 0)
        *(<span class="keywordtype">long</span> <span class="keywordtype">int</span> *)result = 1;
    <span class="keywordflow">else</span> <span class="keywordflow">if</span>(strcmp(value, <span class="stringliteral">"no"</span>) == 0)
        *(<span class="keywordtype">long</span> <span class="keywordtype">int</span> *)result = 2;
    <span class="keywordflow">else</span> <span class="keywordflow">if</span>(strcmp(value, <span class="stringliteral">"maybe"</span>) == 0)
        *(<span class="keywordtype">long</span> <span class="keywordtype">int</span> *)result = 3;
    <span class="keywordflow">else</span> {
        cfg_error(cfg, <span class="stringliteral">"Invalid value for option %s: %s"</span>, opt-&gt;<a class="code" href="structcfg__opt__t.html#cfg__opt__to0">name</a>, value);
        <span class="keywordflow">return</span> -1;
    }
    <span class="keywordflow">return</span> 0;
}

<span class="keywordtype">int</span> cb_validate_bookmark(<a class="code" href="structcfg__t.html">cfg_t</a> *cfg, <a class="code" href="structcfg__opt__t.html">cfg_opt_t</a> *opt)
{
    <span class="comment">/* only validate the last bookmark */</span>
    <a class="code" href="structcfg__t.html">cfg_t</a> *sec = <a name="a5"></a>cfg_opt_getnsec(opt, <a name="a6"></a>cfg_opt_size(opt) - 1);
    <span class="keywordflow">if</span>(!sec)
    {
        cfg_error(cfg, <span class="stringliteral">"section is NULL!?"</span>);
        <span class="keywordflow">return</span> -1;
    }
    <span class="keywordflow">if</span>(<a name="a7"></a>cfg_getstr(sec, <span class="stringliteral">"machine"</span>) == 0)
    {
        cfg_error(cfg, <span class="stringliteral">"machine option must be set for bookmark '%s'"</span>,
                  <a name="a8"></a>cfg_title(sec));
        <span class="keywordflow">return</span> -1;
    }
    <span class="keywordflow">return</span> 0;
}

<span class="keywordtype">int</span> main(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> **argv)
{
    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i;
    <a class="code" href="structcfg__t.html">cfg_t</a> *cfg;
    <span class="keywordtype">unsigned</span> n;
    <span class="keywordtype">int</span> ret;
    <span class="keywordtype">char</span> *pc;

    <span class="keyword">static</span> <a class="code" href="structcfg__opt__t.html">cfg_opt_t</a> proxy_opts[] = {
        <a name="a9"></a><a class="code" href="confuse_8h.html#a21">CFG_INT</a>(<span class="stringliteral">"type"</span>, 0, CFGF_NONE),
        <a name="a10"></a><a class="code" href="confuse_8h.html#a14">CFG_STR</a>(<span class="stringliteral">"host"</span>, 0, CFGF_NONE),
        <a name="a11"></a><a class="code" href="confuse_8h.html#a15">CFG_STR_LIST</a>(<span class="stringliteral">"exclude"</span>, <span class="stringliteral">"{localhost, .localnet}"</span>, CFGF_NONE),
        <a class="code" href="confuse_8h.html#a21">CFG_INT</a>(<span class="stringliteral">"port"</span>, 21, CFGF_NONE),
        <a name="a12"></a><a class="code" href="confuse_8h.html#a46">CFG_END</a>()
    };
    <span class="keyword">static</span> <a class="code" href="structcfg__opt__t.html">cfg_opt_t</a> bookmark_opts[] = {
        <a class="code" href="confuse_8h.html#a14">CFG_STR</a>(<span class="stringliteral">"machine"</span>, 0, CFGF_NONE),
        <a class="code" href="confuse_8h.html#a21">CFG_INT</a>(<span class="stringliteral">"port"</span>, 21, CFGF_NONE),
        <a class="code" href="confuse_8h.html#a14">CFG_STR</a>(<span class="stringliteral">"login"</span>, 0, CFGF_NONE),
        <a class="code" href="confuse_8h.html#a14">CFG_STR</a>(<span class="stringliteral">"password"</span>, 0, CFGF_NONE),
        <a class="code" href="confuse_8h.html#a14">CFG_STR</a>(<span class="stringliteral">"directory"</span>, 0, CFGF_NONE),
        <a name="a13"></a><a class="code" href="confuse_8h.html#a35">CFG_BOOL</a>(<span class="stringliteral">"passive-mode"</span>, cfg_false, CFGF_NONE),
        <a name="a14"></a><a class="code" href="confuse_8h.html#a40">CFG_SEC</a>(<span class="stringliteral">"proxy"</span>, proxy_opts, CFGF_NONE),
        <a class="code" href="confuse_8h.html#a46">CFG_END</a>()
    };
    <a class="code" href="structcfg__opt__t.html">cfg_opt_t</a> opts[] = {
        <a class="code" href="confuse_8h.html#a21">CFG_INT</a>(<span class="stringliteral">"backlog"</span>, 42, CFGF_NONE),
        <a class="code" href="confuse_8h.html#a14">CFG_STR</a>(<span class="stringliteral">"probe-device"</span>, <span class="stringliteral">"eth2"</span>, CFGF_NONE),
        <a class="code" href="confuse_8h.html#a40">CFG_SEC</a>(<span class="stringliteral">"bookmark"</span>, bookmark_opts, CFGF_MULTI | CFGF_TITLE),
        <a name="a15"></a><a class="code" href="confuse_8h.html#a29">CFG_FLOAT_LIST</a>(<span class="stringliteral">"delays"</span>, <span class="stringliteral">"{3.567e2, 0.2, -47.11}"</span>, CFGF_NONE),
        <a name="a16"></a><a class="code" href="confuse_8h.html#a41">CFG_FUNC</a>(<span class="stringliteral">"func"</span>, &amp;cb_func),
        <a name="a17"></a><a class="code" href="confuse_8h.html#a23">CFG_INT_CB</a>(<span class="stringliteral">"ask-quit"</span>, 3, CFGF_NONE, &amp;cb_verify_ask),
        <a name="a18"></a><a class="code" href="confuse_8h.html#a24">CFG_INT_LIST_CB</a>(<span class="stringliteral">"ask-quit-array"</span>, <span class="stringliteral">"{maybe, yes, no}"</span>,
                        CFGF_NONE, &amp;cb_verify_ask),
        <a class="code" href="confuse_8h.html#a41">CFG_FUNC</a>(<span class="stringliteral">"include"</span>, &amp;cfg_include),
        <a class="code" href="confuse_8h.html#a46">CFG_END</a>()
    };

<span class="preprocessor">#ifndef _WIN32</span>
<span class="preprocessor"></span>    <span class="comment">/* for some reason, MS Visual C++ chokes on this (?) */</span>
    printf(<span class="stringliteral">"Using %s\n\n"</span>, confuse_copyright);
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
    cfg = <a name="a19"></a>cfg_init(opts, CFGF_NOCASE);

    <span class="comment">/* set a validating callback function for bookmark sections */</span>
    <a name="a20"></a>cfg_set_validate_func(cfg, <span class="stringliteral">"bookmark"</span>, &amp;cb_validate_bookmark);

    ret = <a name="a21"></a>cfg_parse(cfg, argc &gt; 1 ? argv[1] : <span class="stringliteral">"test.conf"</span>);
    printf(<span class="stringliteral">"ret == %d\n"</span>, ret);
    <span class="keywordflow">if</span>(ret == CFG_FILE_ERROR) {
        perror(<span class="stringliteral">"test.conf"</span>);
        <span class="keywordflow">return</span> 1;
    } <span class="keywordflow">else</span> <span class="keywordflow">if</span>(ret == CFG_PARSE_ERROR) {
        fprintf(stderr, <span class="stringliteral">"parse error\n"</span>);
        <span class="keywordflow">return</span> 2;
    }

    printf(<span class="stringliteral">"backlog == %ld\n"</span>, <a name="a22"></a>cfg_getint(cfg, <span class="stringliteral">"backlog"</span>));

    printf(<span class="stringliteral">"probe device is %s\n"</span>, cfg_getstr(cfg, <span class="stringliteral">"probe-device"</span>));
    <a name="a23"></a>cfg_setstr(cfg, <span class="stringliteral">"probe-device"</span>, <span class="stringliteral">"lo"</span>);
    printf(<span class="stringliteral">"probe device is %s\n"</span>, cfg_getstr(cfg, <span class="stringliteral">"probe-device"</span>));

    n = <a name="a24"></a>cfg_size(cfg, <span class="stringliteral">"bookmark"</span>);
    printf(<span class="stringliteral">"%d configured bookmarks:\n"</span>, n);
    <span class="keywordflow">for</span>(i = 0; i &lt; n; i++) {
        <a class="code" href="structcfg__t.html">cfg_t</a> *pxy;
        <a class="code" href="structcfg__t.html">cfg_t</a> *bm = <a name="a25"></a>cfg_getnsec(cfg, <span class="stringliteral">"bookmark"</span>, i);
        printf(<span class="stringliteral">"  bookmark #%u (%s):\n"</span>, i+1, cfg_title(bm));
        printf(<span class="stringliteral">"    machine = %s\n"</span>, cfg_getstr(bm, <span class="stringliteral">"machine"</span>));
        printf(<span class="stringliteral">"    port = %d\n"</span>, (<span class="keywordtype">int</span>)cfg_getint(bm, <span class="stringliteral">"port"</span>));
        printf(<span class="stringliteral">"    login = %s\n"</span>, cfg_getstr(bm, <span class="stringliteral">"login"</span>));
        printf(<span class="stringliteral">"    passive-mode = %s\n"</span>,
               <a name="a26"></a>cfg_getbool(bm, <span class="stringliteral">"passive-mode"</span>) ? <span class="stringliteral">"true"</span> : <span class="stringliteral">"false"</span>);
        pc = cfg_getstr(bm, <span class="stringliteral">"directory"</span>);
        printf(<span class="stringliteral">"    directory = %s\n"</span>,pc == NULL ? <span class="stringliteral">"(nil)"</span> : pc );
        pc = cfg_getstr(bm, <span class="stringliteral">"password"</span>);
        printf(<span class="stringliteral">"    password = %s\n"</span>, pc == NULL ? <span class="stringliteral">"(nil)"</span> : pc);

        pxy = <a name="a27"></a>cfg_getsec(bm, <span class="stringliteral">"proxy"</span>);
        <span class="keywordflow">if</span>(pxy) {
            <span class="keywordtype">int</span> j, m;
            <span class="keywordflow">if</span>(cfg_getstr(pxy, <span class="stringliteral">"host"</span>) == 0) {
                printf(<span class="stringliteral">"      no proxy host is set, setting it to 'localhost'...\n"</span>);
                <span class="comment">/* For sections without CFGF_MULTI flag set, there is</span>
<span class="comment">                 * also an extended syntax to get an option in a</span>
<span class="comment">                 * subsection:</span>
<span class="comment">                 */</span>
                cfg_setstr(bm, <span class="stringliteral">"proxy|host"</span>, <span class="stringliteral">"localhost"</span>);
            }
            printf(<span class="stringliteral">"      proxy host is %s\n"</span>, cfg_getstr(pxy, <span class="stringliteral">"host"</span>));
            printf(<span class="stringliteral">"      proxy type is %ld\n"</span>, cfg_getint(pxy, <span class="stringliteral">"type"</span>));
            printf(<span class="stringliteral">"      proxy port is %ld\n"</span>, cfg_getint(pxy, <span class="stringliteral">"port"</span>));

            m = cfg_size(pxy, <span class="stringliteral">"exclude"</span>);
            printf(<span class="stringliteral">"      got %d hosts to exclude from proxying:\n"</span>, m);
            <span class="keywordflow">for</span>(j = 0; j &lt; m; j++) {
                printf(<span class="stringliteral">"        exclude %s\n"</span>, <a name="a28"></a>cfg_getnstr(pxy, <span class="stringliteral">"exclude"</span>, j));
            }
        } <span class="keywordflow">else</span>
            printf(<span class="stringliteral">"    no proxy settings configured\n"</span>);
    }

    printf(<span class="stringliteral">"delays are (%d):\n"</span>, cfg_size(cfg, <span class="stringliteral">"delays"</span>));
    <span class="keywordflow">for</span>(i = 0; i &lt; cfg_size(cfg, <span class="stringliteral">"delays"</span>); i++)
        printf(<span class="stringliteral">" %G\n"</span>, <a name="a29"></a>cfg_getnfloat(cfg, <span class="stringliteral">"delays"</span>, i));

    printf(<span class="stringliteral">"ask-quit == %ld\n"</span>, cfg_getint(cfg, <span class="stringliteral">"ask-quit"</span>));

    <span class="comment">/* Using cfg_setint(), the integer value for the option ask-quit</span>
<span class="comment">     * is not verified by the value parsing callback.</span>
<span class="comment">     *</span>
<span class="comment">     *</span>
<span class="comment">     cfg_setint(cfg, "ask-quit", 4);</span>
<span class="comment">     printf("ask-quit == %ld\n", cfg_getint(cfg, "ask-quit"));</span>
<span class="comment">    */</span>

    <span class="comment">/* The following commented line will generate a failed assertion</span>
<span class="comment">     * and abort, since the option "foo" is not declared</span>
<span class="comment">     *</span>
<span class="comment">     *</span>
<span class="comment">     printf("foo == %ld\n", cfg_getint(cfg, "foo"));</span>
<span class="comment">    */</span>

    <a name="a30"></a>cfg_addlist(cfg, <span class="stringliteral">"ask-quit-array"</span>, 2, 1, 2);

    <span class="keywordflow">for</span>(i = 0; i &lt; cfg_size(cfg, <span class="stringliteral">"ask-quit-array"</span>); i++)
        printf(<span class="stringliteral">"ask-quit-array[%d] == %ld\n"</span>,
               i, <a name="a31"></a>cfg_getnint(cfg, <span class="stringliteral">"ask-quit-array"</span>, i));

    <span class="comment">/* print the parsed values to another file */</span>
    {
        FILE *fp = fopen(<span class="stringliteral">"test.conf.out"</span>, <span class="stringliteral">"w"</span>);
        <a name="a32"></a>cfg_set_print_func(cfg, <span class="stringliteral">"func"</span>, print_func);
        cfg_set_print_func(cfg, <span class="stringliteral">"ask-quit"</span>, print_ask);
        cfg_set_print_func(cfg, <span class="stringliteral">"ask-quit-array"</span>, print_ask);
        <a name="a33"></a>cfg_print(cfg, fp);
        fclose(fp);
    }

    <a name="a34"></a>cfg_free(cfg);
    <span class="keywordflow">return</span> 0;
}
</div></pre><pre><div class="fragment">00001 <span class="preprocessor">#include "<a class="code" href="confuse_8h.html">confuse.h</a>"</span>
00002 <span class="preprocessor">#include &lt;string.h&gt;</span>
00003 
00004 <span class="keywordtype">void</span> print_func(<a class="code" href="structcfg__opt__t.html">cfg_opt_t</a> *opt, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> index, FILE *fp)
00005 {
00006     fprintf(fp, <span class="stringliteral">"%s(foo)"</span>, opt-&gt;<a class="code" href="structcfg__opt__t.html#cfg__opt__to0">name</a>);
00007 }
00008 
00009 <span class="keywordtype">void</span> print_ask(<a class="code" href="structcfg__opt__t.html">cfg_opt_t</a> *opt, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> index, FILE *fp)
00010 {
00011     <span class="keywordtype">int</span> value = cfg_opt_getnint(opt, index);
00012     <span class="keywordflow">switch</span>(value) {
00013         <span class="keywordflow">case</span> 1:
00014             fprintf(fp, <span class="stringliteral">"yes"</span>);
00015             <span class="keywordflow">break</span>;
00016         <span class="keywordflow">case</span> 2:
00017             fprintf(fp, <span class="stringliteral">"no"</span>);
00018             <span class="keywordflow">break</span>;
00019         <span class="keywordflow">case</span> 3:
00020         <span class="keywordflow">default</span>:
00021             fprintf(fp, <span class="stringliteral">"maybe"</span>);
00022             <span class="keywordflow">break</span>;
00023     }
00024 }
00025 
00026 <span class="comment">/* function callback</span>
00027 <span class="comment"> */</span>
00028 <span class="keywordtype">int</span> cb_func(<a class="code" href="structcfg__t.html">cfg_t</a> *cfg, <a class="code" href="structcfg__opt__t.html">cfg_opt_t</a> *opt, <span class="keywordtype">int</span> argc, <span class="keyword">const</span> <span class="keywordtype">char</span> **argv)
00029 {
00030     <span class="keywordtype">int</span> i;
00031 
00032     <span class="comment">/* at least one parameter is required */</span>
00033     <span class="keywordflow">if</span>(argc == 0) {
00034         cfg_error(cfg, <span class="stringliteral">"Too few parameters for the '%s' function"</span>,
00035                   opt-&gt;<a class="code" href="structcfg__opt__t.html#cfg__opt__to0">name</a>);
00036         <span class="keywordflow">return</span> -1;
00037     }
00038 
00039     printf(<span class="stringliteral">"cb_func() called with %d parameters:\n"</span>, argc);
00040     <span class="keywordflow">for</span>(i = 0; i &lt; argc; i++)
00041         printf(<span class="stringliteral">"parameter %d: '%s'\n"</span>, i, argv[i]);
00042     <span class="keywordflow">return</span> 0;
00043 }
00044 
00045 <span class="comment">/* value parsing callback</span>
00046 <span class="comment"> *</span>
00047 <span class="comment"> * VALUE must be "yes", "no" or "maybe", and the corresponding results</span>
00048 <span class="comment"> * are the integers 1, 2 and 3.</span>
00049 <span class="comment"> */</span>
00050 <span class="keywordtype">int</span> cb_verify_ask(<a class="code" href="structcfg__t.html">cfg_t</a> *cfg, <a class="code" href="structcfg__opt__t.html">cfg_opt_t</a> *opt, <span class="keyword">const</span> <span class="keywordtype">char</span> *value, <span class="keywordtype">void</span> *result)
00051 {
00052     <span class="keywordflow">if</span>(strcmp(value, <span class="stringliteral">"yes"</span>) == 0)
00053         *(<span class="keywordtype">long</span> <span class="keywordtype">int</span> *)result = 1;
00054     <span class="keywordflow">else</span> <span class="keywordflow">if</span>(strcmp(value, <span class="stringliteral">"no"</span>) == 0)
00055         *(<span class="keywordtype">long</span> <span class="keywordtype">int</span> *)result = 2;
00056     <span class="keywordflow">else</span> <span class="keywordflow">if</span>(strcmp(value, <span class="stringliteral">"maybe"</span>) == 0)
00057         *(<span class="keywordtype">long</span> <span class="keywordtype">int</span> *)result = 3;
00058     <span class="keywordflow">else</span> {
00059         cfg_error(cfg, <span class="stringliteral">"Invalid value for option %s: %s"</span>, opt-&gt;<a class="code" href="structcfg__opt__t.html#cfg__opt__to0">name</a>, value);
00060         <span class="keywordflow">return</span> -1;
00061     }
00062     <span class="keywordflow">return</span> 0;
00063 }
00064 
00065 <span class="keywordtype">int</span> cb_validate_bookmark(<a class="code" href="structcfg__t.html">cfg_t</a> *cfg, <a class="code" href="structcfg__opt__t.html">cfg_opt_t</a> *opt)
00066 {
00067     <span class="comment">/* only validate the last bookmark */</span>
00068     <a class="code" href="structcfg__t.html">cfg_t</a> *sec = cfg_opt_getnsec(opt, cfg_opt_size(opt) - 1);
00069     <span class="keywordflow">if</span>(!sec)
00070     {
00071         cfg_error(cfg, <span class="stringliteral">"section is NULL!?"</span>);
00072         <span class="keywordflow">return</span> -1;
00073     }
00074     <span class="keywordflow">if</span>(cfg_getstr(sec, <span class="stringliteral">"machine"</span>) == 0)
00075     {
00076         cfg_error(cfg, <span class="stringliteral">"machine option must be set for bookmark '%s'"</span>,
00077                   cfg_title(sec));
00078         <span class="keywordflow">return</span> -1;
00079     }
00080     <span class="keywordflow">return</span> 0;
00081 }
00082 
00083 <span class="keywordtype">int</span> main(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> **argv)
00084 {
00085     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i;
00086     <a class="code" href="structcfg__t.html">cfg_t</a> *cfg;
00087     <span class="keywordtype">unsigned</span> n;
00088     <span class="keywordtype">int</span> ret;
00089     <span class="keywordtype">char</span> *pc;
00090 
00091     <span class="keyword">static</span> <a class="code" href="structcfg__opt__t.html">cfg_opt_t</a> proxy_opts[] = {
00092         <a class="code" href="confuse_8h.html#a21">CFG_INT</a>(<span class="stringliteral">"type"</span>, 0, CFGF_NONE),
00093         <a class="code" href="confuse_8h.html#a14">CFG_STR</a>(<span class="stringliteral">"host"</span>, 0, CFGF_NONE),
00094         <a class="code" href="confuse_8h.html#a15">CFG_STR_LIST</a>(<span class="stringliteral">"exclude"</span>, <span class="stringliteral">"{localhost, .localnet}"</span>, CFGF_NONE),
00095         <a class="code" href="confuse_8h.html#a21">CFG_INT</a>(<span class="stringliteral">"port"</span>, 21, CFGF_NONE),
00096         <a class="code" href="confuse_8h.html#a46">CFG_END</a>()
00097     };
00098     <span class="keyword">static</span> <a class="code" href="structcfg__opt__t.html">cfg_opt_t</a> bookmark_opts[] = {
00099         <a class="code" href="confuse_8h.html#a14">CFG_STR</a>(<span class="stringliteral">"machine"</span>, 0, CFGF_NONE),
00100         <a class="code" href="confuse_8h.html#a21">CFG_INT</a>(<span class="stringliteral">"port"</span>, 21, CFGF_NONE),
00101         <a class="code" href="confuse_8h.html#a14">CFG_STR</a>(<span class="stringliteral">"login"</span>, 0, CFGF_NONE),
00102         <a class="code" href="confuse_8h.html#a14">CFG_STR</a>(<span class="stringliteral">"password"</span>, 0, CFGF_NONE),
00103         <a class="code" href="confuse_8h.html#a14">CFG_STR</a>(<span class="stringliteral">"directory"</span>, 0, CFGF_NONE),
00104         <a class="code" href="confuse_8h.html#a35">CFG_BOOL</a>(<span class="stringliteral">"passive-mode"</span>, cfg_false, CFGF_NONE),
00105         <a class="code" href="confuse_8h.html#a40">CFG_SEC</a>(<span class="stringliteral">"proxy"</span>, proxy_opts, CFGF_NONE),
00106         <a class="code" href="confuse_8h.html#a46">CFG_END</a>()
00107     };
00108     <a class="code" href="structcfg__opt__t.html">cfg_opt_t</a> opts[] = {
00109         <a class="code" href="confuse_8h.html#a21">CFG_INT</a>(<span class="stringliteral">"backlog"</span>, 42, CFGF_NONE),
00110         <a class="code" href="confuse_8h.html#a14">CFG_STR</a>(<span class="stringliteral">"probe-device"</span>, <span class="stringliteral">"eth2"</span>, CFGF_NONE),
00111         <a class="code" href="confuse_8h.html#a40">CFG_SEC</a>(<span class="stringliteral">"bookmark"</span>, bookmark_opts, CFGF_MULTI | CFGF_TITLE),
00112         <a class="code" href="confuse_8h.html#a29">CFG_FLOAT_LIST</a>(<span class="stringliteral">"delays"</span>, <span class="stringliteral">"{3.567e2, 0.2, -47.11}"</span>, CFGF_NONE),
00113         <a class="code" href="confuse_8h.html#a41">CFG_FUNC</a>(<span class="stringliteral">"func"</span>, &amp;cb_func),
00114         <a class="code" href="confuse_8h.html#a23">CFG_INT_CB</a>(<span class="stringliteral">"ask-quit"</span>, 3, CFGF_NONE, &amp;cb_verify_ask),
00115         <a class="code" href="confuse_8h.html#a24">CFG_INT_LIST_CB</a>(<span class="stringliteral">"ask-quit-array"</span>, <span class="stringliteral">"{maybe, yes, no}"</span>,
00116                         CFGF_NONE, &amp;cb_verify_ask),
00117         <a class="code" href="confuse_8h.html#a41">CFG_FUNC</a>(<span class="stringliteral">"include"</span>, &amp;cfg_include),
00118         <a class="code" href="confuse_8h.html#a46">CFG_END</a>()
00119     };
00120 
00121 <span class="preprocessor">#ifndef _WIN32</span>
00122 <span class="preprocessor"></span>    <span class="comment">/* for some reason, MS Visual C++ chokes on this (?) */</span>
00123     printf(<span class="stringliteral">"Using %s\n\n"</span>, confuse_copyright);
00124 <span class="preprocessor">#endif</span>
00125 <span class="preprocessor"></span>
00126     cfg = cfg_init(opts, CFGF_NOCASE);
00127 
00128     <span class="comment">/* set a validating callback function for bookmark sections */</span>
00129     cfg_set_validate_func(cfg, <span class="stringliteral">"bookmark"</span>, &amp;cb_validate_bookmark);
00130 
00131     ret = cfg_parse(cfg, argc &gt; 1 ? argv[1] : <span class="stringliteral">"test.conf"</span>);
00132     printf(<span class="stringliteral">"ret == %d\n"</span>, ret);
00133     <span class="keywordflow">if</span>(ret == CFG_FILE_ERROR) {
00134         perror(<span class="stringliteral">"test.conf"</span>);
00135         <span class="keywordflow">return</span> 1;
00136     } <span class="keywordflow">else</span> <span class="keywordflow">if</span>(ret == CFG_PARSE_ERROR) {
00137         fprintf(stderr, <span class="stringliteral">"parse error\n"</span>);
00138         <span class="keywordflow">return</span> 2;
00139     }
00140 
00141     printf(<span class="stringliteral">"backlog == %ld\n"</span>, cfg_getint(cfg, <span class="stringliteral">"backlog"</span>));
00142 
00143     printf(<span class="stringliteral">"probe device is %s\n"</span>, cfg_getstr(cfg, <span class="stringliteral">"probe-device"</span>));
00144     cfg_setstr(cfg, <span class="stringliteral">"probe-device"</span>, <span class="stringliteral">"lo"</span>);
00145     printf(<span class="stringliteral">"probe device is %s\n"</span>, cfg_getstr(cfg, <span class="stringliteral">"probe-device"</span>));
00146 
00147     n = cfg_size(cfg, <span class="stringliteral">"bookmark"</span>);
00148     printf(<span class="stringliteral">"%d configured bookmarks:\n"</span>, n);
00149     <span class="keywordflow">for</span>(i = 0; i &lt; n; i++) {
00150         <a class="code" href="structcfg__t.html">cfg_t</a> *pxy;
00151         <a class="code" href="structcfg__t.html">cfg_t</a> *bm = cfg_getnsec(cfg, <span class="stringliteral">"bookmark"</span>, i);
00152         printf(<span class="stringliteral">"  bookmark #%u (%s):\n"</span>, i+1, cfg_title(bm));
00153         printf(<span class="stringliteral">"    machine = %s\n"</span>, cfg_getstr(bm, <span class="stringliteral">"machine"</span>));
00154         printf(<span class="stringliteral">"    port = %d\n"</span>, (<span class="keywordtype">int</span>)cfg_getint(bm, <span class="stringliteral">"port"</span>));
00155         printf(<span class="stringliteral">"    login = %s\n"</span>, cfg_getstr(bm, <span class="stringliteral">"login"</span>));
00156         printf(<span class="stringliteral">"    passive-mode = %s\n"</span>,
00157                cfg_getbool(bm, <span class="stringliteral">"passive-mode"</span>) ? <span class="stringliteral">"true"</span> : <span class="stringliteral">"false"</span>);
00158         pc = cfg_getstr(bm, <span class="stringliteral">"directory"</span>);
00159         printf(<span class="stringliteral">"    directory = %s\n"</span>,pc == NULL ? <span class="stringliteral">"(nil)"</span> : pc );
00160         pc = cfg_getstr(bm, <span class="stringliteral">"password"</span>);
00161         printf(<span class="stringliteral">"    password = %s\n"</span>, pc == NULL ? <span class="stringliteral">"(nil)"</span> : pc);
00162 
00163         pxy = cfg_getsec(bm, <span class="stringliteral">"proxy"</span>);
00164         <span class="keywordflow">if</span>(pxy) {
00165             <span class="keywordtype">int</span> j, m;
00166             <span class="keywordflow">if</span>(cfg_getstr(pxy, <span class="stringliteral">"host"</span>) == 0) {
00167                 printf(<span class="stringliteral">"      no proxy host is set, setting it to 'localhost'...\n"</span>);
00168                 <span class="comment">/* For sections without CFGF_MULTI flag set, there is</span>
00169 <span class="comment">                 * also an extended syntax to get an option in a</span>
00170 <span class="comment">                 * subsection:</span>
00171 <span class="comment">                 */</span>
00172                 cfg_setstr(bm, <span class="stringliteral">"proxy|host"</span>, <span class="stringliteral">"localhost"</span>);
00173             }
00174             printf(<span class="stringliteral">"      proxy host is %s\n"</span>, cfg_getstr(pxy, <span class="stringliteral">"host"</span>));
00175             printf(<span class="stringliteral">"      proxy type is %ld\n"</span>, cfg_getint(pxy, <span class="stringliteral">"type"</span>));
00176             printf(<span class="stringliteral">"      proxy port is %ld\n"</span>, cfg_getint(pxy, <span class="stringliteral">"port"</span>));
00177 
00178             m = cfg_size(pxy, <span class="stringliteral">"exclude"</span>);
00179             printf(<span class="stringliteral">"      got %d hosts to exclude from proxying:\n"</span>, m);
00180             <span class="keywordflow">for</span>(j = 0; j &lt; m; j++) {
00181                 printf(<span class="stringliteral">"        exclude %s\n"</span>, cfg_getnstr(pxy, <span class="stringliteral">"exclude"</span>, j));
00182             }
00183         } <span class="keywordflow">else</span>
00184             printf(<span class="stringliteral">"    no proxy settings configured\n"</span>);
00185     }
00186 
00187     printf(<span class="stringliteral">"delays are (%d):\n"</span>, cfg_size(cfg, <span class="stringliteral">"delays"</span>));
00188     <span class="keywordflow">for</span>(i = 0; i &lt; cfg_size(cfg, <span class="stringliteral">"delays"</span>); i++)
00189         printf(<span class="stringliteral">" %G\n"</span>, cfg_getnfloat(cfg, <span class="stringliteral">"delays"</span>, i));
00190 
00191     printf(<span class="stringliteral">"ask-quit == %ld\n"</span>, cfg_getint(cfg, <span class="stringliteral">"ask-quit"</span>));
00192 
00193     <span class="comment">/* Using cfg_setint(), the integer value for the option ask-quit</span>
00194 <span class="comment">     * is not verified by the value parsing callback.</span>
00195 <span class="comment">     *</span>
00196 <span class="comment">     *</span>
00197 <span class="comment">     cfg_setint(cfg, "ask-quit", 4);</span>
00198 <span class="comment">     printf("ask-quit == %ld\n", cfg_getint(cfg, "ask-quit"));</span>
00199 <span class="comment">    */</span>
00200 
00201     <span class="comment">/* The following commented line will generate a failed assertion</span>
00202 <span class="comment">     * and abort, since the option "foo" is not declared</span>
00203 <span class="comment">     *</span>
00204 <span class="comment">     *</span>
00205 <span class="comment">     printf("foo == %ld\n", cfg_getint(cfg, "foo"));</span>
00206 <span class="comment">    */</span>
00207 
00208     cfg_addlist(cfg, <span class="stringliteral">"ask-quit-array"</span>, 2, 1, 2);
00209 
00210     <span class="keywordflow">for</span>(i = 0; i &lt; cfg_size(cfg, <span class="stringliteral">"ask-quit-array"</span>); i++)
00211         printf(<span class="stringliteral">"ask-quit-array[%d] == %ld\n"</span>,
00212                i, cfg_getnint(cfg, <span class="stringliteral">"ask-quit-array"</span>, i));
00213 
00214     <span class="comment">/* print the parsed values to another file */</span>
00215     {
00216         FILE *fp = fopen(<span class="stringliteral">"test.conf.out"</span>, <span class="stringliteral">"w"</span>);
00217         cfg_set_print_func(cfg, <span class="stringliteral">"func"</span>, print_func);
00218         cfg_set_print_func(cfg, <span class="stringliteral">"ask-quit"</span>, print_ask);
00219         cfg_set_print_func(cfg, <span class="stringliteral">"ask-quit-array"</span>, print_ask);
00220         cfg_print(cfg, fp);
00221         fclose(fp);
00222     }
00223 
00224     cfg_free(cfg);
00225     <span class="keywordflow">return</span> 0;
00226 }
</div></pre> <!-- doxygen-footer.html starts here -->
  </div>
 </body>
</html>
